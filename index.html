<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voievox SRT ジェネレーター</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="app-header">
      <h1>SRT字幕自動生成ツール</h1>
      <p class="lead">
        ファイルを置いて、フレームレートを選んで、SRT をダウンロードするだけ。その他の細かい調整は必要なときだけ開いてください。
      </p>
    </header>

    <main class="app-main">
      <ol class="flow-steps" aria-label="操作ステップ">
        <li class="flow-step active">ファイルアップロード</li>
        <li class="flow-step">フレームレート設定</li>
        <li class="flow-step">字幕を確認してDL</li>
      </ol>

      <section class="card upload-card">
        <div class="card-header">
          <div>
            <p class="eyebrow">STEP 1</p>
            <h2>ファイルを読み込む</h2>
            <p class="hint">
              フォルダでもファイルでも、ドラッグ&ドロップまたはボタンからまとめて読み込みできます。
            </p>
          </div>
          <div class="import-state" id="importState" aria-live="polite">未選択</div>
        </div>

        <div class="dropzone" id="dropZone" role="region" aria-label="ファイルアップロードエリア">
          <div class="dropzone-icon" aria-hidden="true">⬆</div>
          <p class="dropzone-title">ここにフォルダ・ファイルをドロップ</p>
          <p class="hint">音声(.wav)とテキスト(.txt)のペアをまとめて置いてください。サーバーにはアップロードされません。</p>
          <div class="dropzone-actions">
            <button type="button" id="openPickerButton" class="button button-primary">ファイル/フォルダを選択</button>
            <div class="picker-toggle" id="pickerToggle" role="radiogroup" aria-label="読み込み対象の切り替え">
              <button type="button" class="picker-option active" data-picker-mode="folder" aria-pressed="true">
                フォルダ
              </button>
              <button type="button" class="picker-option" data-picker-mode="file" aria-pressed="false">
                ファイル
              </button>
            </div>
          </div>
          <input id="folderInput" type="file" webkitdirectory directory multiple hidden />
          <input id="fileInput" type="file" multiple accept=".wav,.txt" hidden />
        </div>

        <div id="selectedFiles" class="selected-files" aria-live="polite"></div>
      </section>

      <section class="card">
        <div class="card-header compact">
          <div>
            <p class="eyebrow">STEP 2</p>
            <h2>動画設定</h2>
            <p class="hint">動画編集ソフトで使っているフレームレートを選択、または直接入力してください。</p>
          </div>
          <div class="chip">必須</div>
        </div>

        <form id="settingsForm" class="settings-form">
          <input type="hidden" name="mode" id="modeInput" value="manual" />

          <div class="frame-rate-row">
            <div>
              <p class="section-label">フレームレート</p>
              <div class="frame-rate-presets" id="frameRatePresets" role="radiogroup" aria-label="フレームレートプリセット">
                <button type="button" class="frame-rate-chip" data-frame-rate="23.976">23.976</button>
                <button type="button" class="frame-rate-chip" data-frame-rate="24">24</button>
                <button type="button" class="frame-rate-chip active" data-frame-rate="30">30</button>
                <button type="button" class="frame-rate-chip" data-frame-rate="60">60</button>
                <button type="button" class="frame-rate-chip" data-frame-rate="custom">カスタム</button>
              </div>
            </div>
            <div class="frame-rate-input">
              <label for="frameRate">使用するフレームレート (fps)</label>
              <input
                type="number"
                id="frameRate"
                name="frameRate"
                step="0.001"
                min="1"
                max="240"
                value="30"
              />
            </div>
          </div>

          <details class="advanced" id="advancedSettings">
            <summary>詳細設定（自動調整・フレーム揃え・余剰処理など）</summary>
            <div class="advanced-grid">
              <fieldset>
                <legend>タイミング調整</legend>
                <label class="toggle">
                  <input type="checkbox" id="autoModeToggle" />
                  <span>自動調整モードを使用する</span>
                </label>

                <div class="mode-settings" data-mode="manual">
                  <label for="manualAdjustment">1クリップあたりの加算秒数</label>
                  <input
                    type="number"
                    id="manualAdjustment"
                    name="manualAdjustment"
                    step="0.01"
                    value="0"
                    min="-5"
                    max="5"
                  />
                  <p class="hint">例: 0.02 と指定すると、すべての字幕が0.02秒ずつ伸びます。</p>
                </div>

                <div class="mode-settings hidden" data-mode="auto">
                  <label for="targetTotalTime">目標の合計時間（秒）</label>
                  <input
                    type="number"
                    id="targetTotalTime"
                    name="targetTotalTime"
                    step="0.1"
                    min="0"
                    value="60"
                    required
                  />
                  <p class="hint">選択した音声の合計時間に合わせて、均等に微調整します。</p>
                </div>
              </fieldset>

              <fieldset>
                <legend>フレーム揃え</legend>
                <label class="checkbox">
                  <input type="checkbox" id="enableFrameLock" name="enableFrameLock" checked />
                  <span>フレーム境界に合わせてタイムコードを丸める</span>
                </label>
                <div id="frameRateOptions" class="frame-rate-options">
                  <label class="checkbox">
                    <input type="checkbox" id="trimFrameOverflow" name="trimFrameOverflow" checked />
                    <span>フレームからはみ出した余剰時間を切り捨てる</span>
                  </label>
                  <p class="hint">カスタム値と組み合わせると、タイムラインに合わせた丸めができます。</p>
                </div>
              </fieldset>
            </div>
          </details>

          <div class="submit-row">
            <div>
              <p class="hint">設定はいつでも変更できます。変更後は「字幕を生成」ボタンで再度生成してください。</p>
            </div>
            <button type="submit" class="button button-primary">字幕を生成</button>
          </div>
        </form>
      </section>

      <section class="card" id="results" hidden>
        <div class="card-header compact">
          <div>
            <p class="eyebrow">STEP 3</p>
            <h2>文字・時間一覧とダウンロード</h2>
            <p class="hint">生成した字幕を確認して、最下部のボタンからSRTをダウンロードできます。</p>
          </div>
          <div class="chip success">インポート完了</div>
        </div>

        <div class="result-grid">
          <div>
            <h3>統計</h3>
            <dl class="stats">
              <div>
                <dt>クリップ数</dt>
                <dd id="clipCount">0</dd>
              </div>
              <div>
                <dt>元の合計時間</dt>
                <dd id="originalTotal">0.00 秒</dd>
              </div>
              <div>
                <dt>適用調整値</dt>
                <dd id="adjustment">0.0000 秒</dd>
              </div>
              <div class="auto-only">
                <dt>目標合計時間</dt>
                <dd id="targetTotal">-</dd>
              </div>
              <div class="frame-only">
                <dt>使用フレームレート</dt>
                <dd id="frameRateStat">-</dd>
              </div>
              <div class="frame-only">
                <dt>フレーム揃え後の合計</dt>
                <dd id="frameAlignedTotal">-</dd>
              </div>
              <div class="frame-only">
                <dt>累積のずれ</dt>
                <dd id="frameDrift">-</dd>
              </div>
            </dl>
          </div>
          <div>
            <h3>ログ</h3>
            <pre id="log" class="log"></pre>
          </div>
        </div>

        <div class="table-wrapper">
          <div class="table-header">
            <h3>字幕一覧</h3>
            <span class="chip subtle" id="tableSummary">0 件</span>
          </div>
          <div class="table-scroll">
            <table class="subtitle-table" aria-label="字幕一覧">
              <thead>
                <tr>
                  <th>#</th>
                  <th>ファイル名</th>
                  <th>開始</th>
                  <th>終了</th>
                  <th>テキスト</th>
                </tr>
              </thead>
              <tbody id="subtitleTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="download-row">
          <div>
            <p class="hint">SRTファイルはブラウザ内で生成されます。ダウンロード後もデータは送信されません。</p>
          </div>
          <a id="downloadLink" class="button button-primary" download="output.srt">SRTファイルをダウンロード</a>
        </div>
      </section>
    </main>

    <footer class="app-footer">
      <p>
        同名の <code>.wav</code> と <code>.txt</code> ファイルをペアにして処理します。ファイル名は自動的に昇順で並び替えられます。
      </p>
    </footer>

    <script src="app.js" type="module"></script>
  </body>
</html>
